<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Search Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .portal-group { margin: 20px 0; }
        .portal { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .portal.hidden { display: none; }
        input { padding: 10px; width: 300px; margin-bottom: 20px; }
        h2 { color: #333; }
    </style>
</head>
<body>
    <h1>Fuzzy Search Test for MSPortals.io</h1>
    
    <form style="margin: 0; padding: 0; display: inline">
        <label for="search" style="display: none">Quick Filter:</label>
        <input id="search" name="search" class="quickfilter" type="search" placeholder="Quick Filter" />
    </form>

    <div class="portal-group">
        <h2>Microsoft 365 Admin Portals</h2>
        <div class="portal">
            <span class="portal-name">Microsoft 365 Admin Center</span>
            <div class="portal-details">
                <span class="portal-url">
                    <a href="https://admin.cloud.microsoft" target="_blank">https://admin.cloud.microsoft</a>
                </span>
            </div>
        </div>
        <div class="portal">
            <span class="portal-name">Exchange Admin Center</span>
            <div class="portal-details">
                <span class="portal-url">
                    <a href="https://admin.exchange.microsoft.com" target="_blank">https://admin.exchange.microsoft.com</a>
                </span>
            </div>
        </div>
        <div class="portal">
            <span class="portal-name">SharePoint Admin Center</span>
            <div class="portal-details">
                <span class="portal-url">
                    <a href="https://admin.sharepoint.com" target="_blank">https://admin.sharepoint.com</a>
                </span>
            </div>
        </div>
    </div>

    <div class="portal-group">
        <h2>Azure Portals</h2>
        <div class="portal">
            <span class="portal-name">Azure Portal</span>
            <div class="portal-details">
                <span class="portal-url">
                    <a href="https://portal.azure.com" target="_blank">https://portal.azure.com</a>
                </span>
            </div>
        </div>
        <div class="portal">
            <span class="portal-name">Azure Active Directory</span>
            <div class="portal-details">
                <span class="portal-url">
                    <a href="https://aad.portal.azure.com" target="_blank">https://aad.portal.azure.com</a>
                </span>
            </div>
        </div>
    </div>

    <script src="assets/js/fuzzy-search.js"></script>
    <script>
        // Initialize fuzzy search index
        let fuzzySearchInstance = null;
        let portalElements = [];

        function initializeFuzzySearch() {
            // Build searchable data from DOM elements
            portalElements = Array.from(document.querySelectorAll("div[class='portal-group'] div[class='portal']"));
            
            const searchData = portalElements.map((portalEntry, index) => {
                // Build searchable string that includes all text and link href data
                let searchableString = portalEntry.innerText;
                searchableString += Array.from(portalEntry.getElementsByTagName("a"))
                    .map((e) => e.href)
                    .join(" ");
                
                // Clean up, remove http(s) and newlines
                searchableString = searchableString
                    .replace(/(https|http):\/\//gi, "")
                    .replace(/\n/g, " ")
                    .replace(/\s+/g, " ")
                    .trim();

                return {
                    index: index,
                    content: searchableString,
                    element: portalEntry
                };
            });

            // Configure fuzzy search options
            const fuzzyOptions = {
                keys: ['content'],
                threshold: 0.6 // Lower = more strict, Higher = more fuzzy
            };

            fuzzySearchInstance = new SimpleFuzzySearch(searchData, fuzzyOptions);
        }

        function showOnlyMatchedPortals() {
            const query = this.value;

            // Initialize fuzzy search if not already done
            if (!fuzzySearchInstance && window.SimpleFuzzySearch) {
                initializeFuzzySearch();
            }

            console.log('Search query:', query);

            if (query.length >= 2 && fuzzySearchInstance) {
                // Use fuzzy search to find matches
                const searchResults = fuzzySearchInstance.search(query);
                console.log('Search results:', searchResults);
                const matchedIndices = new Set(searchResults.map(result => result.item.index));
                console.log('Matched indices:', matchedIndices);

                // Hide/show portal entries based on fuzzy search results
                portalElements.forEach((portalEntry, index) => {
                    const isMatch = matchedIndices.has(index);
                    console.log(`Portal ${index} (${portalEntry.innerText.substring(0, 20)}...): ${isMatch ? 'SHOW' : 'HIDE'}`);
                    portalEntry.style.display = isMatch ? 'block' : 'none';
                });
            } else {
                console.log('Showing all portals (query too short)');
                // Show all portals when query is too short or fuzzy search not available
                portalElements.forEach((portalEntry) => {
                    portalEntry.style.display = 'block';
                });
            }

            //Iterate through Portal-groups, and check each portal entries underneath and check if all child portal are hidden
            Array.from(document.querySelectorAll("div[class='portal-group']")).forEach((portalGroup) => {
                let num = Array.from(portalGroup.querySelectorAll(".portal")).reduce(
                    //Count how many elements are not-hidden (shown)
                    (total, elem) => total + (elem.style.display !== 'none' ? 1 : 0),
                    0
                );
                console.log(`Portal group "${portalGroup.querySelector('h2').innerText}" has ${num} visible portals`);
                //If all elements are hidden, hide the entire portal-group
                if (num === 0) {
                    portalGroup.style.display = 'none';
                } else {
                    //If some portal elements are shown, be certain to show the parent portal-group
                    portalGroup.style.display = 'block';
                }
            });
        }

        window.onload = function () {
            // Select Search Box Element
            const qfInput = document.querySelector("#search");

            // Add Event Listeners for changes
            qfInput.addEventListener("change", showOnlyMatchedPortals);
            qfInput.addEventListener("keyup", showOnlyMatchedPortals);
            qfInput.focus({
                preventScroll: true,
            });

            // Initialize fuzzy search when SimpleFuzzySearch is available
            if (window.SimpleFuzzySearch) {
                initializeFuzzySearch();
            }
        };
    </script>
</body>
</html>